# Telegram Bot V2 项目结构图

## 整体架构层次图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户交互层                                 │
│                    (External Users)                              │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      接口适配层                                   │
│                 (Interface Layer)                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  Telegram   │  │     Web     │  │     CLI     │              │
│  │ Interface   │  │ Interface   │  │ Interface   │              │
│  │             │  │             │  │             │              │
│  │ • bot.py    │  │ • routes    │  │ • commands  │              │
│  │ • handlers/ │  │ • controllers│  │ • scripts   │              │
│  │ • ui_handler│  │             │  │             │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      应用核心层                                   │
│                   (Application Core)                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Container   │  │ Application │  │ Lifecycle   │              │
│  │ (DI容器)    │  │ (应用逻辑)   │  │ (生命周期)   │              │
│  │             │  │             │  │             │              │
│  │ • 依赖注入   │  │ • 应用启动   │  │ • 启动钩子   │              │
│  │ • 服务注册   │  │ • 配置管理   │  │ • 关闭钩子   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                        领域层                                    │
│                    (Domain Layer)                               │
│  ┌─────────────────────┐  ┌─────────────────────────────────────┐│
│  │      Models         │  │           Services                  ││
│  │     (实体模型)       │  │         (领域服务)                  ││
│  │                     │  │                                     ││
│  │ • User              │  │ • user_service.py                   ││
│  │ • Payment           │  │ • payment_service.py                ││
│  │ • Image             │  │ • image_service.py                  ││
│  │ • Session           │  │ • session_service.py                ││
│  │ • SystemConfig      │  │ • system_config_service.py          ││
│  │                     │  │ • action_record_service.py          ││
│  └─────────────────────┘  └─────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      基础设施层                                   │
│                 (Infrastructure Layer)                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │  Database   │ │External APIs│ │ Messaging   │ │ Monitoring  │ │
│ │   (数据库)   │ │  (外部API)   │ │   (消息)     │ │   (监控)     │ │
│ │             │ │             │ │             │ │             │ │
│ │• Supabase   │ │• ClothOff   │ │• Queue      │ │• Logging    │ │
│ │• Repositories│ │• Payment    │ │• Events     │ │• Metrics    │ │
│ │  - User     │ │  APIs       │ │             │ │             │ │
│ │  - Payment  │ │             │ │             │ │             │ │
│ │  - Image    │ │             │ │             │ │             │ │
│ │  - Session  │ │             │ │             │ │             │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      工具层                                      │
│                   (Utilities Layer)                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Config    │  │  Constants  │  │   Helpers   │              │
│  │   (配置)     │  │   (常量)     │  │  (帮助函数)  │              │
│  │             │  │             │  │             │              │
│  │ • Settings  │  │ • Messages  │  │ • Utils     │              │
│  │ • Environment│  │ • Status    │  │ • Validators│              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

## 详细目录结构

```
tg_bot_picture_v1/
├── main.py                    # 📍 应用程序入口点
├── requirements.txt           # 📦 Python依赖管理
├── ecosystem.config.js        # 🔧 PM2进程管理配置
├── README.md                 # 📚 项目文档
├── 快速启动.md               # 🚀 快速启动指南
│
├── gpt/                      # 🧠 GPT相关工具
│   ├── prompt/
│   └── utils/
│       └── direct_api.py
│
├── src/                      # 💻 核心源代码目录
│   ├── __init__.py
│   │
│   ├── core/                 # 🔧 应用核心层
│   │   ├── __init__.py
│   │   ├── app.py           # 应用程序配置和初始化
│   │   ├── container.py     # 依赖注入容器 (DI Container)
│   │   └── lifecycle.py     # 应用生命周期管理
│   │
│   ├── domain/              # 🏛️ 领域层 - 业务逻辑核心
│   │   └── services/        # 🔄 领域服务
│   │       ├── user_service.py
│   │       ├── payment_service.py
│   │       ├── image_service.py
│   │       ├── session_service.py
│   │       ├── system_config_service.py
│   │       └── action_record_service.py
│   │
│   ├── infrastructure/      # 🏗️ 基础设施层
│   │   ├── database/        # 💾 数据持久化
│   │   │   ├── __init__.py
│   │   │   ├── supabase_manager.py      # Supabase数据库管理器
│   │   │   ├── repositories/            # v1仓储实现
│   │   │   │   ├── __init__.py
│   │   │   │   ├── base_repository.py
│   │   │   │   ├── user_repository.py
│   │   │   │   ├── point_record_repository.py
│   │   │   │   ├── supabase_base_repository.py
│   │   │   │   ├── supabase_user_repository.py
│   │   │   │   ├── supabase_payment_repository.py
│   │   │   │   ├── supabase_image_task_repository.py
│   │   │   │   ├── supabase_session_record_repository.py
│   │   │   │   ├── supabase_point_record_repository.py
│   │   │   │   ├── supabase_daily_checkin_repository.py
│   │   │   │   ├── supabase_user_session_repository.py
│   │   │   │   ├── supabase_user_action_record_repository.py
│   │   │   │   └── supabase_system_config_repository.py
│   │   │   └── repositories_v2/         # v2仓储实现
│   │   │       ├── single/
│   │   │       │   ├── __init__.py
│   │   │       │   ├── base_repository_v2.py
│   │   │       │   ├── user_repository_v2.py
│   │   │       │   ├── user_session_repository_v2.py
│   │   │       │   ├── session_record_repository_v2.py
│   │   │       │   ├── user_action_record_repository_v2.py
│   │   │       │   ├── user_activity_stats_repository_v2.py
│   │   │       │   ├── user_wallet_repository_v2.py
│   │   │       │   ├── payment_order_repository_v2.py
│   │   │       │   ├── image_task_repository_v2.py
│   │   │       │   ├── daily_checkin_repository_v2.py
│   │   │       │   └── point_record_repository_v2.py
│   │   │       └── composite/
│   │   │           ├── __init__.py
│   │   │           ├── user_composite_repository.py
│   │   │           ├── session_composite_repository.py
│   │   │           ├── point_composite_repository.py
│   │   │           └── action_composite_repository.py
│   │   │
│   │   ├── external_apis/   # 🌐 外部API集成
│   │   │   ├── __init__.py
│   │   │   ├── clothoff_api.py          # ClothOff图像处理API
│   │   │   └── payment_api.py           # 支付API集成
│   │   │
│   │   └── messaging/       # 📨 Webhook/消息处理
│   │       ├── webhook_handler.py
│   │       ├── image_webhook.py
│   │       └── payment_webhook.py
│   │
│   ├── interfaces/          # 🔌 接口适配层
│   │   └── telegram/        # 🤖 Telegram Bot接口
│   │       ├── bot.py                   # Telegram Bot主控制器
│   │       ├── ui_handler.py            # UI交互处理器
│   │       ├── user_state_manager.py    # 用户状态管理
│   │       └── handlers/                # 各种处理器
│   │           ├── callback_manager.py  # 回调处理管理器
│   │           ├── message_handlers.py  # 消息处理器
│   │           ├── image_processing.py  # 图像处理处理器
│   │           ├── callback/            # 回调处理器集合
│   │           │   ├── base_callback_handler.py
│   │           │   ├── function_callbacks.py
│   │           │   ├── image_generation_callbacks.py
│   │           │   ├── payment_callbacks.py
│   │           │   └── profile_callbacks.py
│   │           └── command/             # 命令处理器集合
│   │               ├── base_command_handler.py
│   │               ├── admin_commands.py
│   │               ├── payment_commands.py
│   │               └── user_commands.py
│   │
│   └── utils/               # 🛠️ 通用工具层
│       └── config/          # ⚙️ 配置管理
│           ├── app_config.py
│           └── settings.py
│
├── tests/                   # 🧪 测试代码目录
│   ├── test_telegram_bot.py
│   ├── test_user_service.py
│   ├── test_payment_service.py
│   ├── test_image_service.py
│   ├── test_clothoff_api.py
│   ├── test_database.py
│   ├── test_supabase.py
│   ├── test_integration.py
│   ├── test_webhook_handler.py
│   ├── quick_test.py
│   └── setup_supabase.py
│
├── scripts/                 # 📜 运维脚本
│   ├── deploy/
│   │   ├── manage_webhook.sh
│   │   ├── pm2_manager.sh
│   │   ├── rollback.sh
│   │   └── run.sh
│   └── git/
│       └── snapshot.sh
│
├── logs/                    # 📝 日志文件目录
├── data/                    # 📁 数据存储目录
│   └── telegram_bot_v2.db
└── docs/                    # 📖 文档目录
    ├── WEBHOOK_GUIDE.md
    ├── PM2_使用说明.md
    └── db/
        ├── Service与组合Repository调用关系分析报告.md
        └── supabase_tables_v2.sql
```

## 核心组件交互流程

```
┌─────────────┐    HTTP/Webhook    ┌─────────────────┐
│   Telegram  │ ─────────────────► │  Telegram Bot   │
│   Platform  │                    │   Interface     │
└─────────────┘                    └─────────┬───────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Handler Pipeline                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Message   │  │  Callback   │  │   Image     │             │
│  │  Handlers   │  │  Handlers   │  │ Processing  │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Domain Services                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │    User     │  │   Payment   │  │    Image    │             │
│  │   Service   │  │   Service   │  │   Service   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│              Infrastructure Services                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  Supabase   │  │  ClothOff   │  │   Payment   │             │
│  │ Repositories│  │     API     │  │     API     │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 架构特点

### 🏗️ 设计模式
- **Clean Architecture**: 分层架构，依赖倒置
- **Domain Driven Design (DDD)**: 领域驱动设计
- **Repository Pattern**: 数据访问抽象
- **Dependency Injection**: 依赖注入容器管理
- **CQRS**: 命令查询职责分离

### 🔧 核心技术栈
- **语言**: Python 3.x
- **Web框架**: Python-telegram-bot
- **数据库**: Supabase (PostgreSQL)
- **外部API**: ClothOff图像处理API
- **部署**: PM2进程管理
- **依赖管理**: pip requirements.txt

### 📊 主要功能模块
1. **用户管理**: 注册、认证、积分系统
2. **图像处理**: 基于AI的图像处理服务
3. **支付系统**: 积分充值和消费管理
4. **会话管理**: 用户状态和对话流程
5. **系统配置**: 动态配置管理
6. **操作记录**: 用户行为追踪和审计

### 🚀 部署和运维
- **进程管理**: PM2 ecosystem配置
- **日志管理**: 结构化日志记录
- **健康检查**: 服务监控和状态检查
- **数据迁移**: Supabase数据库迁移脚本 