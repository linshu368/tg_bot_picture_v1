# Telegram Bot AI图像处理项目架构图

## 项目概述

本项目是一个基于Telegram Bot的AI服务平台，包含两个主要Bot应用：

### 主要应用
- **图像处理Bot** (`main.py`) - AI图像处理服务
- **文本聊天Bot** (`app_text_bot.py`) - AI对话服务

### 核心功能
- 🤖 Telegram Bot交互界面
- 🖼️ AI图像处理（使用ClothOff API）
- 💬 AI对话与会话管理
- 💰 积分充值与支付系统
- 👤 用户管理与会话控制
- 📊 数据持久化（Supabase）
- 🔧 完整的运维工具链


## 分层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        外部用户层                                │
│                    (Telegram Users)                             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      接口适配层                                  │
│                 (Interface Adapters)                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot Interface                      │   │
│  │  ├─ bot.py              主Bot控制器（图像处理）          │   │
│  │  ├─ text_bot.py         文本聊天Bot控制器                │   │
│  │  ├─ ui_handler.py       UI交互处理                      │   │
│  │  ├─ user_state_manager  用户状态管理                     │   │
│  │  ├─ controllers/        控制器层                        │   │
│  │  │   └─ session_controller.py  会话控制器              │   │
│  │  └─ handlers/           处理器集合                       │   │
│  │      ├─ message_handlers.py    消息处理                 │   │
│  │      ├─ callback_manager.py    回调管理                 │   │
│  │      ├─ callback/              回调处理器               │   │
│  │      └─ command/               命令处理器               │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      应用核心层                                  │
│                   (Application Core)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Container   │  │ Application  │  │  Lifecycle   │          │
│  │  依赖注入容器 │  │   应用管理    │  │  生命周期管理 │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                        领域层                                    │
│                    (Domain Layer)                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Domain Services                       │   │
│  │  ├─ user_service.py         用户管理服务                │   │
│  │  ├─ payment_service.py      支付管理服务                │   │
│  │  ├─ session_service_base.py 会话管理基类                │   │
│  │  ├─ session_service.py      会话管理服务                │   │
│  │  ├─ message_service.py      消息处理服务                │   │
│  │  ├─ action_record_service   行为记录服务                │   │
│  │  └─ ai_completion_port.py   AI补全端口接口              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      基础设施层                                  │
│                 (Infrastructure Layer)                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│
│ │  Database   │ │External APIs│ │  Webhooks   │ │ Messaging   ││
│ │  数据持久化  │ │  外部API集成 │ │  回调处理   │ │  消息处理   ││
│ │             │ │             │ │             │ │             ││
│ │ Supabase    │ │ ClothOff    │ │ Image Hook  │ │ Webhook     ││
│ │ Manager     │ │ API         │ │ Payment Hook│ │ Handler     ││
│ │             │ │             │ │             │ │             ││
│ │ V2 Repos:   │ │ Payment     │ │ Flask Apps  │ │ Processor   ││
│ │ • Composite │ │ API         │ │             │ │             ││
│ │ • Single    │ │             │ │             │ │             ││
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 详细目录结构

```
/mnt/tg_bot_picture_v1/
├── main.py                    # 🚀 主应用程序入口（图像处理Bot）
├── app_text_bot.py            # 🤖 文本聊天Bot入口
├── requirements.txt           # 📦 Python依赖包列表
├── ecosystem.config.js        # ⚙️ PM2进程管理配置
├── README.md                  # 📚 项目说明文档
├── 快速启动.md                # 🏃 快速启动指南
│
├── src/                       # 💼 源代码主目录
│   ├── __init__.py
│   │
│   ├── core/                  # 🎯 应用核心层
│   │   ├── __init__.py
│   │   ├── app.py            # 应用主类
│   │   ├── container.py      # 依赖注入容器配置
│   │   └── lifecycle.py      # 应用生命周期管理
│   │
│   ├── domain/               # 🏛️ 领域层（业务逻辑）
│   │   └── services/         # 领域服务
│   │       ├── user_service.py          # 用户管理（注册、签到、积分）
│   │       ├── payment_service.py       # 支付处理（订单、充值）
│   │       ├── session_service_base.py  # 会话管理基类
│   │       ├── session_service.py       # 会话管理服务
│   │       ├── message_service.py       # 消息处理服务
│   │       ├── action_record_service.py # 用户行为记录
│   │       └── ai_completion_port.py    # AI补全端口接口
│   │
│   ├── infrastructure/       # 🏗️ 基础设施层
│   │   ├── database/         # 数据库相关
│   │   │   ├── __init__.py
│   │   │   ├── supabase_manager.py     # Supabase连接管理
│   │   │   ├── repositories/          # V1版本仓储（逐步废弃中）
│   │   │   │   ├── __init__.py
│   │   │   │   ├── base_repository.py
│   │   │   │   ├── point_record_repository.py
│   │   │   │   ├── user_repository.py
│   │   │   │   ├── supabase_base_repository.py
│   │   │   │   ├── supabase_user_repository.py
│   │   │   │   ├── supabase_payment_repository.py
│   │   │   │   ├── supabase_image_task_repository.py
│   │   │   │   ├── supabase_point_record_repository.py
│   │   │   │   ├── supabase_daily_checkin_repository.py
│   │   │   │   ├── supabase_user_session_repository.py
│   │   │   │   ├── supabase_session_record_repository.py
│   │   │   │   ├── supabase_user_action_record_repository.py
│   │   │   │   └── supabase_system_config_repository.py
│   │   │   └── repositories_v2/       # V2版本仓储（主要使用）
│   │   │       ├── composite/         # 组合仓储（跨表事务）
│   │   │       │   ├── __init__.py
│   │   │       │   ├── user_composite_repository.py
│   │   │       │   ├── point_composite_repository.py
│   │   │       │   ├── session_composite_repository.py
│   │   │       │   └── action_composite_repository.py
│   │   │       └── single/            # 单表仓储
│   │   │           ├── __init__.py
│   │   │           ├── base_repository_v2.py
│   │   │           ├── user_repository_v2.py
│   │   │           ├── user_wallet_repository_v2.py
│   │   │           ├── user_activity_stats_repository_v2.py
│   │   │           ├── payment_order_repository_v2.py
│   │   │           ├── image_task_repository_v2.py
│   │   │           ├── point_record_repository_v2.py
│   │   │           ├── daily_checkin_repository_v2.py
│   │   │           ├── user_session_repository_v2.py
│   │   │           ├── session_record_repository_v2.py
│   │   │           └── user_action_record_repository_v2.py
│   │   │
│   │   ├── external_apis/    # 外部API集成
│   │   │   ├── __init__.py
│   │   │   ├── clothoff_api.py        # ClothOff图像处理API
│   │   │   └── payment_api.py         # 支付接口封装
│   │   │
│   │   └── messaging/        # 消息和Webhook处理
│   │       ├── webhook_handler.py     # Webhook处理基类
│   │       ├── image_webhook.py       # 图像处理回调服务
│   │       └── payment_webhook.py     # 支付回调服务
│   │
│   ├── interfaces/           # 🔌 接口适配层
│   │   └── telegram/         # Telegram Bot接口实现
│   │       ├── bot.py                 # Bot主控制器（图像处理）
│   │       ├── text_bot.py            # 文本聊天Bot控制器
│   │       ├── ui_handler.py          # UI交互处理
│   │       ├── user_state_manager.py  # 用户状态管理
│   │       ├── controllers/           # 控制器层
│   │       │   └── session_controller.py  # 会话控制器
│   │       └── handlers/              # 各类处理器
│   │           ├── message_handlers.py      # 消息处理
│   │           ├── callback_manager.py      # 回调管理
│   │           ├── callback/                # 回调处理器
│   │           │   ├── __init__.py
│   │           │   ├── base_callback_handler.py
│   │           │   ├── function_callbacks.py      # 功能回调
│   │           │   ├── payment_callbacks.py       # 支付回调
│   │           │   ├── profile_callbacks.py       # 个人资料回调
│   │           │   └── text_bot_callback_handler.py # 文本Bot回调
│   │           └── command/                 # 命令处理器
│   │               ├── __init__.py
│   │               ├── base_command_handler.py
│   │               ├── admin_commands.py    # 管理员命令
│   │               ├── payment_commands.py  # 支付相关命令
│   │               └── user_commands.py     # 用户命令
│   │
│   └── utils/                # 🛠️ 工具类
│       └── config/           # 配置管理
│           ├── app_config.py          # 应用配置
│           └── settings.py            # 设置管理
│
├── ops/                      # 🔧 运维工具集
│   ├── deploy/              # 部署脚本（预留）
│   ├── runtime/             # 运行时管理
│   │   ├── manage_webhook.sh   # Webhook管理脚本
│   │   └── pm2_manager.sh      # PM2进程管理脚本
│   ├── git/                 # Git工作流管理
│   │   ├── README.md           # Git工具说明
│   │   ├── config.sh           # Git配置脚本
│   │   ├── install_hooks.sh    # 安装Git钩子
│   │   ├── rollback.sh         # 版本回滚脚本
│   │   ├── commit/             # 提交相关
│   │   │   ├── commit_msg.sh       # 提交信息生成
│   │   │   ├── gen_commit_msg.py   # Python提交信息生成
│   │   │   └── post-commit.sh      # 提交后钩子
│   │   ├── push/               # 推送相关
│   │   │   ├── gen_pushlog.py      # 生成推送日志
│   │   │   └── pre-push-hook.sh    # 推送前钩子
│   │   └── logs/               # Git操作日志
│   │       ├── pushlogs/           # 推送日志记录
│   │       └── snapshots/          # 快照记录
│   └── gpt/                 # 🤖 GPT辅助工具
│       ├── param.py             # GPT参数配置
│       ├── prompt/              # 提示词模板
│       │   ├── commit_process_diff.prompt
│       │   ├── push_log_arch2pr.prompt
│       │   ├── push_log_title.prompt
│       │   └── solid_save/         # 架构文档存档
│       │       ├── long/               # 长文档
│       │       │   ├── arch.txt
│       │       │   ├── principle.txt
│       │       │   └── project_business_goal.txt
│       │       └── mid/                # 中文档
│       │           ├── requirements_functional_spec.txt
│       │           └── workstream/        # 工作流文档
│       │               ├── git_version_control.txt
│       │               └── mission_textbot_p1.txt
│       └── utils/               # GPT工具函数
│           ├── direct_api.py
│           └── files_utils.py
│
├── scripts/                  # 📜 辅助脚本
│   └── run.sh               # 运行脚本
│
├── demo/                     # 🧪 演示代码
│   ├── api.py               # API演示
│   ├── main.py              # 主演示
│   └── role.py              # 角色演示
│
├── tests/                    # 🧪 测试代码
│   ├── conftest.py          # pytest配置
│   ├── quick_test.py        # 快速测试脚本
│   ├── setup_supabase.py    # Supabase设置测试
│   ├── test_database.py     # 数据库测试
│   ├── test_telegram_bot.py # Telegram Bot测试
│   ├── test_user_service.py # 用户服务测试
│   ├── test_payment_service.py # 支付服务测试
│   ├── test_image_service.py   # 图像服务测试
│   ├── test_clothoff_api.py    # ClothOff API测试
│   ├── test_supabase.py        # Supabase测试
│   ├── test_integration.py     # 集成测试
│   ├── test_webhook_handler.py # Webhook测试
│   └── text_bot/               # 文本Bot测试
│       ├── test_session_controller.py
│       └── test_session_service_base.py
│
├── data/                     # 📊 数据文件
│   └── telegram_bot_v2.db   # SQLite数据库（备用）
│
├── docs/                     # 📖 项目文档
│   ├── 项目结构图.md         # 本文档
│   ├── WEBHOOK_GUIDE.md     # Webhook使用指南
│   ├── PM2_使用说明.md      # PM2使用说明
│   └── db/                  # 数据库文档
│       ├── Service与组合Repository调用关系分析报告.md
│       └── supabase_tables_v2.sql
│
└── venv/                     # 🐍 Python虚拟环境
```



## 技术栈

### 架构模式
- **Clean Architecture** - 清洁架构，分层设计
- **Dependency Injection** - 依赖注入模式
- **Repository Pattern** - 仓储模式
- **Composite Repository** - 组合仓储（V2新增）

### 架构设计原则 
既要保证未来半年内系统的可维护性，可拓展性。又要坚持敏捷开发的节奏。需要在功能开发和系统维护成本之间寻求平衡。具体这个平衡点的关键因素就是项目的阶段，是起步期，成长期，还是成熟期。
目前的项目是起步期，所以不要过份的追求架构的固化，但是遵循以下设计原则。

 1. **依赖倒置原则（DIP）**

* **类型**：面向对象设计原则
* **类别**：**高层设计原则**
* **描述**：DIP 强调了高层模块不应依赖于低层模块，而应依赖于抽象（接口或抽象类）。这有助于降低模块间的耦合度，方便系统扩展和维护。

 2. **单一职责原则（SRP）**

* **类型**：面向对象设计原则
* **类别**：**类设计原则**
* **描述**：SRP 确保一个类或模块只负责一个功能，从而减少了类的复杂度，提升了可维护性和可扩展性。

 3. **开闭原则（OCP）**

* **类型**：面向对象设计原则
* **类别**：**扩展性与稳定性原则**
* **描述**：OCP 鼓励系统的可扩展性，即对功能的扩展要开放，对修改关闭。通过使用抽象和多态等方式，可以在不修改现有代码的情况下增加新的功能。

 4. **里氏替换原则（LSP）**

* **类型**：面向对象设计原则
* **类别**：**继承与多态原则**
* **描述**：LSP 确保子类对象可以替代父类对象而不会影响程序的行为，是开闭原则的基础之一，保证了继承结构的正确性和稳定性。

 5. **接口隔离原则（ISP）**

* **类型**：面向对象设计原则
* **类别**：**接口设计原则**
* **描述**：ISP 强调接口应当小而专一，避免大而全的接口。通过拆分接口，每个接口满足特定用户的需求，减少了不必要的依赖。


这些原则属于 **面向对象设计（OOD）** 的范畴，目的是通过高效的设计模式和结构，降低系统的耦合度，提高可维护性、可扩展性和稳定性。它们帮助开发团队在面对复杂系统时做出清晰的架构决策，从而保证系统的长远发展。


### 开发风格——敏捷开发
这是一个面向C端的产品，且是初期，所以要快速迭代。

1. **模块化与解耦性**：保持代码灵活和高度模块化，确保团队能够快速迭代各个模块，而不影响整体系统。每个模块应易于替换和升级，以便在敏捷开发中实现快速调整。

2. **快速迭代与持续交付**：强调通过短周期的开发与交付，快速推出最小可行产品（MVP）并验证市场需求。确保每次迭代都能快速响应用户反馈并进行优化。

3. **用户驱动与反馈循环**：敏捷开发强调与用户保持紧密的联系，确保开发优先级与实际需求紧密对接。定期收集用户反馈并进行快速的调整和改进。

4. **跨职能协作**：团队成员之间应紧密合作，跨职能的沟通和协作能够提高开发效率并减少需求变更导致的延误。

5. **自动化测试与持续集成**：确保系统具备强大的自动化测试和持续集成能力，以减少回归问题，并确保每次迭代都能快速、安全地部署。

