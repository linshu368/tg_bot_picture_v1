# 跨表场景梳理报告

## 概述
在从单表结构升级到 v2 多表结构后，以下业务场景从"单一 repository 操作"变成了"多个 repository 协作"：

---

## 1. 用户注册场景 (UserService.register_user)

### 现状分析
**原来**: 一个 UserRepository 就能完成用户创建和积分初始化
**现在**: 需要操作 4 张表

### 涉及的表和操作
```
users_v2 → 创建用户基本信息
user_wallet_v2 → 初始化钱包 (积分余额=默认积分, 等级=1)  
user_activity_stats_v2 → 初始化活动统计 (会话数=0, 消息数=0)
point_records_v2 → 记录注册奖励积分流水
```

### 事务要求
- 所有操作必须在同一事务中完成
- 任何一步失败都需要回滚
- 用户创建 → 钱包创建 → 统计初始化 → 积分记录，有依赖顺序

---

## 2. 积分操作场景 (UserService.add_points / consume_points)

### 现状分析  
**原来**: 更新用户表积分字段 + 创建积分记录
**现在**: 用户积分信息分离到钱包表

### 涉及的表和操作
```
user_wallet_v2 → 更新积分余额、消费统计
point_records_v2 → 记录积分变动流水 (关联 related_event_id)
```

### 事务要求
- 钱包更新和积分记录必须同时成功
- 需要获取当前余额，验证充足性（消费场景）
- 余额计算必须准确，避免并发问题

---

## 3. 支付成功场景 (PaymentService._process_payment_success)

### 现状分析
**原来**: 支付订单 + 用户积分更新 + 积分记录  
**现在**: 用户钱包独立管理，需要更多统计信息

### 涉及的表和操作  
```
payment_orders_v2 → 更新订单状态为已完成
user_wallet_v2 → 更新积分余额、累计充值金额、首冲状态
point_records_v2 → 记录充值积分流水 (基础积分+赠送积分)
```

### 事务要求
- 订单状态更新、积分发放、统计更新必须原子性
- 首充判断逻辑需要准确
- 支持赠送积分的分别记录

---

## 4. 图像任务创建场景 (ImageService.create_image_task + 积分扣除)

### 现状分析
**原来**: 创建任务 + 扣除用户积分 + 积分记录
**现在**: 积分管理独立到钱包表，需要任务关联

### 涉及的表和操作
```  
user_wallet_v2 → 检查余额充足性，扣除积分
image_tasks_v2 → 创建图像任务
point_records_v2 → 记录积分消费 (关联任务 action_id)
```

### 事务要求
- 余额检查和扣除必须原子性
- 任务创建失败需要回滚积分扣除
- 需要记录任务和积分记录的关联关系

---

## 5. 会话管理场景 (SessionService + 活动统计更新)

### 现状分析  
**原来**: 可能在一个复合表中管理
**现在**: 会话状态、会话记录、活动统计分离

### 涉及的表和操作
```
user_sessions_v2 → 管理当前会话状态
session_records_v2 → 记录会话历史  
user_activity_stats_v2 → 更新会话数、消息数统计
```

### 事务要求
- 会话创建时需要同时更新统计
- 会话结束时需要更新会话记录和统计
- 消息计数需要实时更新活动统计

---

## 6. 每日签到场景 (UserService.daily_checkin)

### 现状分析
**原来**: 签到表 + 用户积分更新 + 积分记录  
**现在**: 积分管理独立，签到记录独立

### 涉及的表和操作
```
daily_checkins_v2 → 检查今日签到状态，创建签到记录
user_wallet_v2 → 更新积分余额
point_records_v2 → 记录签到积分流水
```

### 事务要求
- 签到状态检查和积分发放必须原子性
- 防止重复签到
- 签到记录和积分记录需要关联

---

## 7. 用户行为记录场景 (ActionRecordService + 统计更新)

### 现状分析
**原来**: 单纯的行为记录
**现在**: 可能需要联动更新活动统计

### 涉及的表和操作
```
user_action_records_v2 → 记录具体行为
user_activity_stats_v2 → 更新相关活动统计 (可选)
```

### 事务要求
- 行为记录创建
- 根据行为类型选择性更新统计

---

## 总结：需要组合 Repository 的核心场景

### 高频场景 (必须优先处理)
1. **用户注册** - 4表联动 (users + wallet + stats + points)
2. **积分操作** - 2表联动 (wallet + points)  
3. **支付完成** - 3表联动 (payment + wallet + points)
4. **图像任务+积分扣除** - 3表联动 (wallet + tasks + points)

### 中频场景
5. **会话管理** - 3表联动 (sessions + records + stats)
6. **每日签到** - 3表联动 (checkins + wallet + points)

### 低频场景
7. **行为记录+统计** - 2表联动 (actions + stats)

---

## 下一步：设计组合 Repository

基于以上分析，建议设计以下组合 Repository：

  1. UserCompositeRepository
    - 用户注册（users + wallet + stats + points）
    - 签到奖励（checkins + wallet + points）
  2. PointCompositeRepository
    - 积分操作（wallet + points）
    - 积分支付（payment + wallet + points）
    - 任务积分扣除（wallet + tasks + points）
  3. SessionCompositeRepository
    - 会话管理（sessions + records + stats）
  4. ActionCompositeRepository（低频场景，独立出来）
    - 行为记录 + 统计（actions + stats）