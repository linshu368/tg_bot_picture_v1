# Telegram Bot V2 - é‡æ„ç‰ˆ

åŸºäºæ¨¡å—åŒ–æ¶æ„é‡æ„çš„Telegramå›¾åƒå¤„ç†æœºå™¨äººï¼Œéµå¾ªé¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)åŸåˆ™ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç›®å½•ç»“æ„

```
tg_bot_picture_v1/
â”œâ”€â”€ main.py                    # ğŸ“ åº”ç”¨ç¨‹åºå…¥å£ç‚¹
â”œâ”€â”€ requirements.txt           # ğŸ“¦ Pythonä¾èµ–ç®¡ç†
â”œâ”€â”€ ecosystem.config.js        # ğŸ”§ PM2è¿›ç¨‹ç®¡ç†é…ç½®
â”œâ”€â”€ pm2_manager.sh            # ğŸ› ï¸ PM2ç®¡ç†è„šæœ¬
â”œâ”€â”€ README.md                 # ğŸ“š é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ å¿«é€Ÿå¯åŠ¨.md               # ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—
â”‚
â”œâ”€â”€ src/                      # ğŸ’» æ ¸å¿ƒæºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                 # ğŸ”§ åº”ç”¨æ ¸å¿ƒå±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ app.py           # åº”ç”¨ç¨‹åºé…ç½®å’Œåˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ container.py     # ä¾èµ–æ³¨å…¥å®¹å™¨ (DI Container)
â”‚   â”‚   â””â”€â”€ lifecycle.py     # åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/              # ğŸ›ï¸ é¢†åŸŸå±‚ - ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ models/          # ğŸ“Š é¢†åŸŸæ¨¡å‹/å®ä½“
â”‚   â”‚   â””â”€â”€ services/        # ğŸ”„ é¢†åŸŸæœåŠ¡
â”‚   â”‚       â”œâ”€â”€ user_service.py           # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ payment_service.py        # æ”¯ä»˜å¤„ç†æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ image_service.py          # å›¾åƒå¤„ç†æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ session_service.py        # ä¼šè¯ç®¡ç†æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ system_config_service.py  # ç³»ç»Ÿé…ç½®æœåŠ¡
â”‚   â”‚       â””â”€â”€ action_record_service.py  # æ“ä½œè®°å½•æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/      # ğŸ—ï¸ åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ database/        # ğŸ’¾ æ•°æ®æŒä¹…åŒ–
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ supabase_manager.py      # Supabaseæ•°æ®åº“ç®¡ç†å™¨
â”‚   â”‚   â”‚   â””â”€â”€ repositories/            # æ•°æ®ä»“å‚¨æ¨¡å¼å®ç°
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ base_repository.py   # åŸºç¡€ä»“å‚¨æŠ½è±¡
â”‚   â”‚   â”‚       â”œâ”€â”€ user_repository.py   # ç”¨æˆ·æ•°æ®ä»“å‚¨
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_user_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_payment_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_image_task_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_session_record_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_point_record_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_daily_checkin_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_user_session_repository.py
â”‚   â”‚   â”‚       â”œâ”€â”€ supabase_user_action_record_repository.py
â”‚   â”‚   â”‚       â””â”€â”€ supabase_system_config_repository.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ external_apis/   # ğŸŒ å¤–éƒ¨APIé›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ clothoff_api.py          # ClothOffå›¾åƒå¤„ç†API
â”‚   â”‚   â”‚   â””â”€â”€ payment_api.py           # æ”¯ä»˜APIé›†æˆ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ messaging/       # ğŸ“¨ æ¶ˆæ¯å¤„ç†åŸºç¡€è®¾æ–½
â”‚   â”‚   â””â”€â”€ monitoring/      # ğŸ“Š ç›‘æ§å’Œæ—¥å¿—åŸºç¡€è®¾æ–½
â”‚   â”‚
â”‚   â”œâ”€â”€ interfaces/          # ğŸ”Œ æ¥å£é€‚é…å±‚
â”‚   â”‚   â”œâ”€â”€ telegram/        # ğŸ¤– Telegram Botæ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ bot.py                   # Telegram Botä¸»æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ ui_handler.py            # UIäº¤äº’å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ user_state_manager.py    # ç”¨æˆ·çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ handlers/                # å„ç§å¤„ç†å™¨
â”‚   â”‚   â”‚       â”œâ”€â”€ callback_manager.py  # å›è°ƒå¤„ç†ç®¡ç†å™¨
â”‚   â”‚   â”‚       â”œâ”€â”€ message_handlers.py  # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”‚   â”‚       â”œâ”€â”€ image_processing.py  # å›¾åƒå¤„ç†å¤„ç†å™¨
â”‚   â”‚   â”‚       â”œâ”€â”€ callback/            # å›è°ƒå¤„ç†å™¨é›†åˆ
â”‚   â”‚   â”‚       â””â”€â”€ command/             # å‘½ä»¤å¤„ç†å™¨é›†åˆ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ web/             # ğŸŒ Web APIæ¥å£
â”‚   â”‚   â””â”€â”€ cli/             # ğŸ’» å‘½ä»¤è¡Œæ¥å£
â”‚   â”‚
â”‚   â””â”€â”€ utils/               # ğŸ› ï¸ é€šç”¨å·¥å…·å±‚
â”‚       â”œâ”€â”€ config/          # âš™ï¸ é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ constants/       # ğŸ“‹ å¸¸é‡å®šä¹‰
â”‚       â””â”€â”€ helpers/         # ğŸ”§ è¾…åŠ©å‡½æ•°
â”‚
â”œâ”€â”€ tests/                   # ğŸ§ª æµ‹è¯•ä»£ç ç›®å½•
â”‚   â”œâ”€â”€ test_telegram_bot.py             # Telegram Botæµ‹è¯•
â”‚   â”œâ”€â”€ test_user_service.py             # ç”¨æˆ·æœåŠ¡æµ‹è¯•
â”‚   â”œâ”€â”€ test_payment_service.py          # æ”¯ä»˜æœåŠ¡æµ‹è¯•
â”‚   â”œâ”€â”€ test_image_service.py            # å›¾åƒæœåŠ¡æµ‹è¯•
â”‚   â”œâ”€â”€ test_clothoff_api.py             # ClothOff APIæµ‹è¯•
â”‚   â”œâ”€â”€ test_database.py                 # æ•°æ®åº“æµ‹è¯•
â”‚   â”œâ”€â”€ test_supabase.py                 # Supabaseé›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_integration.py              # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_webhook_handler.py          # Webhookå¤„ç†å™¨æµ‹è¯•
â”‚   â”œâ”€â”€ quick_test.py                    # å¿«é€Ÿæµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ setup_supabase.py                # Supabaseè®¾ç½®è„šæœ¬
â”‚
â”œâ”€â”€ scripts/                 # ğŸ“œ è¿ç»´å’Œæ•°æ®åº“è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ migrate_to_supabase.py           # Supabaseè¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ check_migration_status.py        # è¿ç§»çŠ¶æ€æ£€æŸ¥
â”‚   â”œâ”€â”€ supabase_tables.sql              # æ•°æ®åº“è¡¨ç»“æ„
â”‚   â”œâ”€â”€ manage_webhook.sh                # Webhookç®¡ç†è„šæœ¬
â”‚   â””â”€â”€ test_integration.py              # é›†æˆæµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ logs/                    # ğŸ“ æ—¥å¿—æ–‡ä»¶ç›®å½•
â”œâ”€â”€ data/                    # ğŸ“ æ•°æ®å­˜å‚¨ç›®å½•
â””â”€â”€ docs/                    # ğŸ“– æ–‡æ¡£ç›®å½•
```
å¦‚æœæ‚¨æƒ³ç†è§£æ›´è¯¦ç»†çš„é¡¹ç›®æ¶æ„ï¼Œè¯·ç§»æ­¥  docs/é¡¹ç›®ç»“æ„å›¾.md 

### æ¶æ„å±‚æ¬¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ¥å£é€‚é…å±‚                  â”‚  â† å¤„ç†å¤–éƒ¨è¯·æ±‚/å“åº”
â”‚   (Telegram/Web/CLI Interfaces)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            ä¸šåŠ¡é¢†åŸŸå±‚                 â”‚  â† æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚      (Domain Services & Models)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           åŸºç¡€è®¾æ–½å±‚                  â”‚  â† æŠ€æœ¯å®ç°ç»†èŠ‚
â”‚  (Database/APIs/Monitoring)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½®è®¾ç½®
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®æ‚¨çš„Bot Tokenç­‰
nano .env
```

### 3. è¿è¡Œåº”ç”¨
```bash
# å¯åŠ¨æœºå™¨äºº
python main.py
```

## ğŸ”§ é‡æ„æ”¹è¿›

### ä¸V1ç‰ˆæœ¬å¯¹æ¯”

**V1ç‰ˆæœ¬é—®é¢˜ï¼š**
- å•ä¸€å¤§æ–‡ä»¶ï¼ˆtelegram_bot.py 4000+è¡Œï¼‰
- é«˜è€¦åˆåº¦ï¼Œéš¾ä»¥æµ‹è¯•
- é…ç½®åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
- æ— æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ

**V2ç‰ˆæœ¬æ”¹è¿›ï¼š**
- âœ… æ¨¡å—åŒ–æ¶æ„ï¼Œå•ä¸€èŒè´£
- âœ… ä¾èµ–æ³¨å…¥ï¼Œä½è€¦åˆåº¦
- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†
- âœ… æ¸…æ™°çš„å±‚æ¬¡åˆ†ç¦»
- âœ… æ˜“äºæµ‹è¯•å’Œæ‰©å±•

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£** - æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
2. **ä¾èµ–å€’ç½®** - é¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œéå…·ä½“å®ç°
3. **å¼€é—­åŸåˆ™** - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
4. **æ¥å£éš”ç¦»** - å®¢æˆ·ç«¯ä¸åº”ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½
1. åœ¨`domain/services/`ä¸­åˆ›å»ºä¸šåŠ¡æœåŠ¡
2. åœ¨`infrastructure/`ä¸­å®ç°å…·ä½“æŠ€æœ¯ç»†èŠ‚
3. åœ¨`interfaces/telegram/handlers/`ä¸­æ·»åŠ ç”¨æˆ·æ¥å£
4. åœ¨`container.py`ä¸­æ³¨å†Œä¾èµ–å…³ç³»

### æµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest
```

## ğŸ”„ è¿ç§»è¯´æ˜

è¿™æ˜¯åŸé¡¹ç›®çš„é‡æ„ç‰ˆæœ¬ï¼Œä½¿ç”¨æ–°çš„Bot Tokenä»¥ä¾¿äºç‹¬ç«‹æµ‹è¯•ã€‚

**è¿ç§»ä¼˜åŠ¿ï¼š**
- æ¸è¿›å¼é‡æ„ï¼Œé™ä½é£é™©
- ä¿æŒåŠŸèƒ½å®Œæ•´æ€§
- æé«˜ä»£ç è´¨é‡
- ä¾¿äºåç»­ç»´æŠ¤

## ğŸ“‹ å¾…åŠäº‹é¡¹

- [ ] å®Œæˆæ•°æ®åº“å±‚é‡æ„
- [ ] å®ç°ä¸šåŠ¡æœåŠ¡å±‚
- [ ] è¿ç§»Telegramæ¥å£å±‚
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„ 