
## 分层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        外部用户层                                │
│                    (Telegram Users)                             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      接口适配层                                  │
│                 (Interface Adapters)                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot Interface                      │   │
│  │  ├─ bot.py              主Bot控制器                      │   │
│  │  ├─ ui_handler.py       UI交互处理                      │   │
│  │  ├─ user_state_manager  用户状态管理                     │   │
│  │  └─ handlers/           处理器集合                       │   │
│  │      ├─ message_handlers.py    消息处理                 │   │
│  │      ├─ callback_manager.py    回调管理                 │   │
│  │      ├─ image_processing.py    图像处理                 │   │
│  │      ├─ callback/              回调处理器               │   │
│  │      └─ command/               命令处理器               │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      应用核心层                                  │
│                   (Application Core)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Container   │  │ Application  │  │  Lifecycle   │          │
│  │  依赖注入容器 │  │   应用管理    │  │  生命周期管理 │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                        领域层                                    │
│                    (Domain Layer)                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Domain Services                       │   │
│  │  ├─ user_service.py         用户管理服务                │   │
│  │  ├─ payment_service.py      支付管理服务                │   │
│  │  ├─ image_service.py        图像处理服务                │   │
│  │  ├─ session_service.py      会话管理服务                │   │
│  │  ├─ action_record_service   行为记录服务                │   │
│  │  └─ system_config_service   系统配置服务                │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      基础设施层                                  │
│                 (Infrastructure Layer)                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│
│ │  Database   │ │External APIs│ │  Webhooks   │ │ Messaging   ││
│ │  数据持久化  │ │  外部API集成 │ │  回调处理   │ │  消息处理   ││
│ │             │ │             │ │             │ │             ││
│ │ Supabase    │ │ ClothOff    │ │ Image Hook  │ │ Webhook     ││
│ │ Manager     │ │ API         │ │ Payment Hook│ │ Handler     ││
│ │             │ │             │ │             │ │             ││
│ │ V2 Repos:   │ │ Payment     │ │ Flask Apps  │ │ Processor   ││
│ │ • Composite │ │ API         │ │             │ │             ││
│ │ • Single    │ │             │ │             │ │             ││
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│
└─────────────────────────────────────────────────────────────────┘
```